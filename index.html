<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extractor de Remitos - Optimizado PRO</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f4f9; }
.container { max-width:1100px; margin:auto; background:white; padding:20px; border-radius:10px; }
.upload-box { background:#e7f3ff; border:2px dashed #007bff; padding:20px; text-align:center; border-radius:8px; margin-bottom:20px; }
label { font-weight:bold; display:block; margin-top:10px; }
input, select { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
button { padding:8px 12px; margin-top:10px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; }
.btn-blue { background:#007bff; color:white; width:100%; }
.btn-green { background:#28a745; color:white; width:100%; }
.btn-orange { background:#fd7e14; color:white; }
.btn-red { background:#dc3545; color:white; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f1f1f1; }
#estado { text-align:center; font-weight:bold; margin-top:10px; }
#tempCanvas { display:none; }
</style>
</head>
<body>

<div class="container">
  <h2>Extractor de Remitos - PRO</h2>

  <div class="upload-box">
    <input type="file" id="imageInput" accept="image/*" />
    <button class="btn-blue" onclick="ejecutarLectura()">PROCESAR IMAGEN</button>
  </div>

  <p id="estado"></p>
  <canvas id="tempCanvas"></canvas>

  <label>Nombre</label>
  <input type="text" id="nombre" />

  <label>Cuenta</label>
  <input type="text" id="cuenta" />

  <label>Nro Remito</label>
  <input type="text" id="remito" />
</div>

<script>
"use strict";

/* ===========================
   OCR
=========================== */
async function ejecutarLectura() {

  const file = document.getElementById("imageInput").files[0];
  if (!file) return alert("Selecciona una imagen");

  const estado = document.getElementById("estado");
  estado.innerText = "Procesando imagen...";

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await new Promise(resolve => img.onload = resolve);

  const canvas = document.getElementById("tempCanvas");
  const ctx = canvas.getContext("2d");

  canvas.width = img.width;
  canvas.height = img.height;

  ctx.filter = "grayscale(1) contrast(2) brightness(1.2)";
  ctx.drawImage(img, 0, 0);

  const { data } = await Tesseract.recognize(canvas, "spa");

  console.log("===== TEXTO OCR =====");
  console.log(data.text);

  extraerInformacion(data.text);

  estado.innerText = "Lectura finalizada ✔";
}

/* ===========================
   EXTRACTOR PROFESIONAL
=========================== */
function extraerInformacion(texto="") {

  const textoLimpio = texto.replace(/\r/g,"");
  const lineas = textoLimpio.split("\n").map(l=>l.trim()).filter(Boolean);

  let nombre = "";
  let cuenta = "";
  let remito = "";

  /* ================= REMITO ================= */
  const regexRemito = /\b(1101|1104|0104|3008|1107|3009)[-\s]?\d{5,}\b/;
  const matchRemito = texto.match(regexRemito);
  if (matchRemito) {
    remito = matchRemito[0].replace(/\s+/g,"-");
  }

  /* ================= CUENTA ================= */
  for (let linea of lineas) {

    // Cuenta: 65811
    let matchCuenta = linea.match(/(Cta\.?|Cuenta)[^\d]{0,5}(\d{4,})/i);
    if (matchCuenta) {
      cuenta = matchCuenta[2];
      break;
    }

    // Número entre paréntesis (110797)
    let matchParentesis = linea.match(/\((\d{4,})\)/);
    if (matchParentesis && !cuenta) {
      cuenta = matchParentesis[1];
    }
  }

  /* ================= NOMBRE ================= */
  for (let linea of lineas) {

    // Nombre: XXXXX
    let matchNombre = linea.match(/Nombre[:\s]+(.+)/i);
    if (matchNombre) {
      nombre = limpiarTexto(matchNombre[1]);
      break;
    }

    // Sr.(es): XXXXX
    let matchSr = linea.match(/Sr\.?\(?es\)?[:\s]+(.+)/i);
    if (matchSr) {
      nombre = limpiarTexto(matchSr[1]);
      break;
    }

    // Nombre dentro de paréntesis (Maria Silva)
    let matchParentesisNombre = linea.match(/\(([A-Za-zÁÉÍÓÚÑáéíóúñ\s\.]+)\)/);
    if (matchParentesisNombre && !nombre) {
      nombre = limpiarTexto(matchParentesisNombre[1]);
    }

    // Formato APELLIDO, NOMBRE
    if (!nombre && /^[A-ZÁÉÍÓÚÑ\s]+,\s?[A-ZÁÉÍÓÚÑ\s]+$/.test(linea)) {
      nombre = limpiarTexto(linea);
    }
  }

  document.getElementById("nombre").value = nombre;
  document.getElementById("cuenta").value = cuenta;
  document.getElementById("remito").value = remito;
}

/* ===========================
   LIMPIEZA
=========================== */
function limpiarTexto(txt){
  return txt
    .replace(/[^A-Za-zÁÉÍÓÚÑáéíóúñ\s,]/g,"")
    .replace(/\s+/g," ")
    .trim();
}
</script>

</body>
</html>
